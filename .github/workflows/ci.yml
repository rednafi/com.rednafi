name: Deploy Hugo site to Cloudflare Pages

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 1"

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.154.2
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Cache Hugo
        uses: actions/cache@v4
        id: cache-hugo
        with:
          path: ~/hugo.deb
          key: hugo-${{ env.HUGO_VERSION }}

      - name: Download Hugo
        if: steps.cache-hugo.outputs.cache-hit != 'true'
        run: wget -q -O ~/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb

      - name: Install Hugo
        run: sudo dpkg -i ~/hugo.deb

      - name: Build with Hugo
        run: hugo --gc --minify

      - name: Build Pagefind search index
        run: npx -y pagefind

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: false

      - name: Test URL reachability
        run: |
          npx -y serve public -l 1313 &
          sleep 2
          go run scripts/test_urls.go -url http://localhost:1313
          pkill -f serve || true

      - name: Deploy to Cloudflare Pages
        run: npx wrangler pages deploy ./public --project-name=rednafi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: f2c208344e8adb0cf3ea1e48dccf7218
